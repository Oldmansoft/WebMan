var oldmanWebApp,$app;oldmanWebApp={setting:{timeover:180000},text:{confirm:"Cofirm",cancel:"Cancel",loading:"Loading"},_mainView:null,_openView:null,_activeView:null,_fnOnUnauthorized:function(){return false},_currentViewEvent:null,_isDealEmptyTarget:true,messageBox:null,windowBox:null,getAbsolutePath:function(b,d,a){if(b==""){b=a}if(b.substr(0,1)=="/"){return b}if(!d){d=document.location.pathname}var c=d.split("/");c.pop();return c.join("/")+"/"+b},getPathHasAbsolutePathFromArray:function(d,b,a){for(var c=b;c>-1;c--){if(d[c]==""&&a.substr(0,1)=="/"){return a}if(d[c].substr(0,1)=="/"){return d[c]}}return null},scriptLoader:new function(){var c=[];function b(f,e,d){if(f.length==e+1){d.resolve()}else{a(f,e+1,d)}}function a(f,e,d){if(c[f[e]]){b(f,e,d);return}$.getScript(f[e],function(){c[f[e]]=true;b(f,e,d)})}this.load=function(){var d=$.Deferred();if(arguments.length==0){d.resolve()}else{a(arguments,0,d)}return d}},bodyManagement:new function(){var a=0;this.expand=function(){if(a==0){$("body").addClass("layout-expanded")}a++};this.shrink=function(){a--;if(a==0){$("body").removeClass("layout-expanded")}if(a<0){throw"shrink error"}}},createView:function(a,b){return $("<div></div>").addClass(a+"-view").data("link",b)},createEvent:function(){this.load=function(){};this.unload=function(){};this.active=function(){};this.inactive=function(){}},linkManagement:function(){var a=[];function b(c){this.link=c;this.node=null;this.scrollTop=0;this.scrollLeft=0;this.event=null;this.visible=true;this.view=null;this.level=0;this.hide=function(){if(!this.node||!this.visible){return}var d=$(window);this.scrollTop=d.scrollTop();this.scrollLeft=d.scrollLeft();this.event.inactive(this.view,this.level);this.node.hide();this.visible=false};this.remove=function(){if(!this.node){return}this.event.inactive(this.view,this.level);this.event.unload(this.view,this.level);this.node.remove();this.node=null;this.event=null};this.show=function(){if(!this.node||this.visible){return}this.node.show();this.event.active(this.view,this.level);$(window).scrollLeft(this.scrollLeft);$(window).scrollTop(this.scrollTop);this.visible=true}}this.push=function(c){a.push(new b(c))};this.pop=function(){return a.pop()};this.last=function(){return a[a.length-1]};this.setLastContext=function(f,e,c,g){var d=this.last();d.node=f;d.event=e;d.view=c;d.level=g;return d};this.like=function(c){if(a.length==0){return false}for(var d=0;d<a.length;d++){if(c.length==d){break}if(a[d].link!=c[d]){return false}}return true};this.count=function(){return a.length};this.get=function(c){return a[c]};this.hasNode=function(c){return a[c].node!=null};this.replace=function(c,d){a[c]=new b(d)};this.getBackLink=function(){var d=[],c;d.push("");for(c=0;c<a.length-1;c++){d.push(a[c].link)}return d.join("#")};this.getLinks=function(){var c=[],d;for(d=0;d<a.length;d++){c.push(a[d].link)}return c}},box:function(h,g){var d=false,c,b,i=[],f=null;function e(k,j){if(k&&k.target!=k.currentTarget){return}c.stop(true);c.fadeOut(200,function(){oldmanWebApp.bodyManagement.shrink();if(f.close){f.close()}f.node.remove();if(i.length>0){f=i.pop();b.append(f.node);if(j){j()}c.stop(true,true);c.fadeIn(200);return}f=null;if(j){j()}})}function a(){if(d){return}d=true;c=$("<div></div>").addClass(h).addClass("box-background");if(g){b=$("<div></div>").addClass("layout-horizontal");c.append(b);c.append($("<div></div>").addClass("layout-vertical"))}else{b=c}c.prependTo($("body"))}this.show=function(j,k){a();if(f){if(f.node.data("type")=="message"){throw"not allow show again after message show."}i.push({node:f.node.detach(),close:f.close})}oldmanWebApp.bodyManagement.expand();f={node:j,close:k};b.append(j);c.stop(true,true);c.fadeIn(200)};this.hide=function(k,j){e(k,j)};this.clear=function(){if(!f){return}if(f.close){f.close()}f.node.remove();while(i.length>0){f=i.pop();b.append(f.node);if(f.close){f.close()}f.node.remove()}f=null;c.hide()}},dialog:new function(){function b(c){this.set=function(f,e){var d=$("<button></button>").text(f);d.click(function(g){oldmanWebApp.messageBox.hide(g,e)});c.append(d);return this}}function a(){var c=$("<div></div>").addClass("dialog-box").addClass("box-panel");this.setHead=function(d){var e=$("<div></div>").addClass("dialog-header");e.append($("<h4></h4>").text(d));c.append(e)};this.setBody=function(e){var d=$("<div></div>").addClass("dialog-body").text(e);c.append(d)};this.setFooter=function(f,d){var e=$("<div></div>").addClass("dialog-footer");c.append(e);return new b(e)};this.get=function(d){c.data("type",d);return c};this.getElement=function(){return c}}this.alert=function(e,f,d){var c=new a();if(f){c.setHead(f)}c.setBody(e);c.setFooter().set(oldmanWebApp.text.confirm,d);oldmanWebApp.messageBox.show(c.get("alert"))};this.confirm=function(e,f,d){var c=new a();c.setBody(e);c.setFooter().set(oldmanWebApp.text.confirm,f).set(oldmanWebApp.text.cancel,d);oldmanWebApp.messageBox.show(c.get("confirm"))};this.message=function(d){var c=new a();c.setBody(d);oldmanWebApp.messageBox.show(c.get("message"));return new function(){this.hide=function(e){oldmanWebApp.messageBox.hide(null,e)};this.change=function(e){c.getElement().find(".dialog-body").text(e)}}}},loadingTip:new function(){var a;function b(){if(a!=null){return}a=$("<div></div>").addClass("loading-background").addClass("box-background");var c=$("<div></div>").addClass("loading-box").addClass("box-panel"),d=$("<span></span>").text(oldmanWebApp.text.loading);c.append(d);a.append($("<div></div>").addClass("layout-horizontal").append(c)).append($("<div></div>").addClass("layout-vertical"));a.prependTo($("body"))}this.show=function(){b();oldmanWebApp.bodyManagement.expand();a.stop(true,true);a.fadeIn(2000);return new function(){this.hide=function(){oldmanWebApp.loadingTip.hide()}}};this.hide=function(){b();a.stop(true);a.fadeOut(200,function(){oldmanWebApp.bodyManagement.shrink()})}},link:new function(){var b=false,f=null,a=null;function c(h){if(!h){return h}if(h.substr(0,1)=="#"){return h.substr(1)}return h}function g(){return f}function e(){a(g())}function d(){var h=c(window.location.hash);if(f==h){return}f=h;e()}this.hash=function(h){if(h==undefined){return window.location.hash}window.location.hash=h;if(h==f){this.refresh()}return h};this.addHash=function(h){h=c(h);if(window.location.hash==""){window.location.hash="##"+h}else{window.location.hash+="#"+h}};this.sameHash=function(h){h=c(h);var i=window.location.hash.split("#");if(i.length==1){i=["",""]}i.pop();i.push(h);window.location.hash=i.join("#");if(h==f){this.refresh()}};this.refresh=function(){e()};this._init=function(h){if(b){return}b=true;a=h;f=c(window.location.hash);if("onhashchange" in window){window.onhashchange=d}else{window.setInterval(function(){if(f!=c(window.location.hash)){d()}},100)}e()}},openArea:function(d){var a=d,b=new oldmanWebApp.linkManagement();function c(i,j,f){var e,h,g;if(b.count()>0){b.last().hide()}else{oldmanWebApp._mainView.inactiveCurrent();oldmanWebApp._activeView=oldmanWebApp._openView}e=oldmanWebApp.createView("open",i);oldmanWebApp._currentViewEvent=new oldmanWebApp.createEvent();if(f==undefined){e.html(j)}else{e.append(j).append(f)}h=oldmanWebApp._currentViewEvent;b.push(i);g=b.setLastContext(e,h,"open",b.count());oldmanWebApp.windowBox.show(e,function(){g.remove()});h.load("open",b.count());h.active("open",b.count())}this.load=function(e){var f=oldmanWebApp.loadingTip.show();$.ajax({mimeType:"text/html; charset=utf-8",url:oldmanWebApp.getAbsolutePath(e,oldmanWebApp.getPathHasAbsolutePathFromArray(b.getLinks(),b.count()-2,a),a),type:"GET",timeout:oldmanWebApp.setting.timeover}).done(function(j,k,i){f.hide();var g=i.getResponseHeader("X-Responded-JSON"),h;if(g){h=JSON.parse(g);if(h.status==401){if(!oldmanWebApp._fnOnUnauthorized(h.headers.location)){if(h.headers&&h.headers.location){document.location=h.headers.location;return}}}}c(e,j)}).fail(function(i,l,j){f.hide();if(i.status==401){oldmanWebApp._fnOnUnauthorized(e)}var g=$(i.responseText),k=$("<h4></h4>").text(j),h=$("<pre></pre>");if(g[11]!=null&&g[11].nodeType==8){h.text(g[11].data)}else{h.text(g.eq(1).text())}c(e,k,h)})};this.close=function(){b.pop();oldmanWebApp.windowBox.hide(null,function(){var e=b.last();if(e){e.show()}else{oldmanWebApp._activeView=oldmanWebApp._mainView;oldmanWebApp._mainView.activeCurrent()}})};this.clear=function(){oldmanWebApp.windowBox.clear();if(b.count()>0){b=new oldmanWebApp.linkManagement()}}},viewArea:function(b,g){var d=0,e=$(b),a=g,c=new oldmanWebApp.linkManagement();function f(l,n,m,j){var i,k;if(n){n()}i=oldmanWebApp.createView("main",l);e.append(i);oldmanWebApp._currentViewEvent=new oldmanWebApp.createEvent();if(j==undefined){i.html(m)}else{i.append(m).append(j)}k=oldmanWebApp._currentViewEvent;c.setLastContext(i,k,"main",c.count());k.load("main",c.count());k.active("main",c.count());$(window).scrollTop(0);oldmanWebApp.dealScrollToVisibleLoading()}function h(j,m,k){var i=++d,l;l=oldmanWebApp.loadingTip.show();$.ajax({mimeType:"text/html; charset=utf-8",url:oldmanWebApp.getAbsolutePath(j,m,a),type:"GET",timeout:oldmanWebApp.setting.timeover}).done(function(q,r,p){if(i!=d){return}l.hide();var n=p.getResponseHeader("X-Responded-JSON"),o;if(n){o=JSON.parse(n);if(o.status==401){if(!oldmanWebApp._fnOnUnauthorized(o.headers.location)){if(o.headers&&o.headers.location){document.location=o.headers.location;return}}}}f(j,k,q)}).fail(function(p,s,q){if(i!=d){return}l.hide();if(p.status==401){oldmanWebApp._fnOnUnauthorized(j)}var n=$(p.responseText),r=$("<h4></h4>").text(q),o=$("<pre></pre>");if(n[11]!=null&&n[11].nodeType==8){o.text(n[11].data)}else{o.text(n.eq(1).text())}f(j,k,r,o)})}this.load=function(l){var m=l.split("#"),k,j;oldmanWebApp._openView.clear();oldmanWebApp.messageBox.clear();if(c.count()>m.length&&c.like(m)&&(c.hasNode(m.length-1))){for(k=c.count()-1;k>m.length-1;k--){j=c.pop();if(j.node){j.remove()}}c.get(m.length-1).show();return}h(m[m.length-1],oldmanWebApp.getPathHasAbsolutePathFromArray(m,m.length-2,a),function(){var n=c.count(),i=m.length;for(k=n-1;k>i-1;k--){c.pop().remove()}for(k=0;k<i;k++){if(n>k){if(c.get(k).link!=m[k]||(n==k+1&&i==n)){c.get(k).remove();c.replace(k,m[k])}else{c.get(k).hide()}}else{c.push(m[k])}}})};this.close=function(){if(c.count()>1){oldmanWebApp.link.hash(c.getBackLink())}};this.getElement=function(){return e};this.setElement=function(i){return e=$(i)};this.getDefaultLink=function(){return a};this.setDefaultLink=function(i){a=i};this.activeCurrent=function(){c.last().show()};this.inactiveCurrent=function(){c.last().hide()}},event:function(){return new function(){this.onLoad=function(a){oldmanWebApp._currentViewEvent.load=a;return this};this.onUnload=function(a){oldmanWebApp._currentViewEvent.unload=a;return this};this.onActive=function(a){oldmanWebApp._currentViewEvent.active=a;return this};this.onInactive=function(a){oldmanWebApp._currentViewEvent.inactive=a;return this}}},viewClose:function(){oldmanWebApp._activeView.close()},dealScrollToVisibleLoading:function(){var b=$(".webapp-loading:visible"),a;if(b.length>0&&!b.data("work")&&$(window).scrollTop()+$(window).height()>b.offset().top){b.data("work",true);a=b.attr("data-src");if(!a){return}$.get(a,function(c){b.before(c);b.remove();oldmanWebApp.dealScrollToVisibleLoading()})}},dealHrefTarget:{_base:function(a){oldmanWebApp.link.hash(a)},_add:function(a){oldmanWebApp.link.addHash(a)},_same:function(a){oldmanWebApp.link.sameHash(a)},_open:function(a){oldmanWebApp.open(a)}},open:function(a){oldmanWebApp._openView.load(a)},configSetting:function(a){if(typeof a=="function"){a(oldmanWebApp.setting)}},configText:function(a){if(typeof a=="function"){a(oldmanWebApp.text)}},initOption:function(a){this.viewNode=function(b){if(!b){return a.getElement()}a.setElement(b);return this};this.defaultLink=function(b){if(!b){return a.getDefaultLink()}a.setDefaultLink(b);return this};this.unauthorized=function(b){oldmanWebApp._fnOnUnauthorized=b;return this};this.dealEmptyTarget=function(c){if(c==undefined){return oldmanWebApp._isDealEmptyTarget}oldmanWebApp._isDealEmptyTarget=c;return this}},init:function(b,a){if(!!window.ActiveXObject||"ActiveXObject" in window){$.ajaxSetup({cache:false})}$("body").on("click","a",function(f){var d=$(this).attr("target"),c=$(this).attr("href");if(c=="#"){f.preventDefault();return}if($(this).hasClass("webapp-close")){f.preventDefault();oldmanWebApp.viewClose();return}if(!d){if(!oldmanWebApp._isDealEmptyTarget){return}f.preventDefault();oldmanWebApp.dealHrefTarget._base(c);return}if(oldmanWebApp.dealHrefTarget[d]){f.preventDefault();oldmanWebApp.dealHrefTarget[d](c)}});$(window).bind("scroll",oldmanWebApp.dealScrollToVisibleLoading);$(window).bind("resize",oldmanWebApp.dealScrollToVisibleLoading);oldmanWebApp._mainView=new oldmanWebApp.viewArea(b,a);oldmanWebApp._openView=new oldmanWebApp.openArea(a);oldmanWebApp._activeView=oldmanWebApp._mainView;oldmanWebApp.link._init(function(c){oldmanWebApp._mainView.load(c)},a);return new oldmanWebApp.initOption(oldmanWebApp._mainView)}};oldmanWebApp.messageBox=new oldmanWebApp.box("dialog-background",true);oldmanWebApp.windowBox=new oldmanWebApp.box("window-background");$app={configSetting:oldmanWebApp.configSetting,configText:oldmanWebApp.configText,alert:oldmanWebApp.dialog.alert,confirm:oldmanWebApp.dialog.confirm,message:oldmanWebApp.dialog.message,loading:oldmanWebApp.loadingTip.show,loadScript:oldmanWebApp.scriptLoader.load,hash:oldmanWebApp.link.hash,baseHash:oldmanWebApp.link.hash,addHash:oldmanWebApp.link.addHash,sameHash:oldmanWebApp.link.sameHash,open:oldmanWebApp.open,event:oldmanWebApp.event,close:oldmanWebApp.viewClose,init:oldmanWebApp.init};